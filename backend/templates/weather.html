{% extends "base.html" %}

{% block title %}ì„œìš¸ ë‚ ì”¨ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<h1>ğŸŒ¤ ì„œìš¸ í˜„ì¬ ë‚ ì”¨</h1>

<div class="weather-layout">
    <div id="map"></div>

    <div id="weatherCard" class="weather-card">
        <div class="placeholder">ì§€ë„ì—ì„œ êµ¬ë¥¼ í´ë¦­í•˜ì„¸ìš”</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
    .weather-layout {
        display: flex;
        gap: 24px;
    }

    /* ì§€ë„ */
    #map {
        width: 58%;
        height: 520px;
        border-radius: 14px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, .15);
    }

    /* ì¹´ë“œ */
    .weather-card {
        width: 42%;
        background: #fff;
        border-radius: 14px;
        padding: 24px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, .15);
    }

    .placeholder {
        text-align: center;
        margin-top: 180px;
        color: #777;
    }

    /* ì§€ë„ ë¼ë²¨ */
    .weather-label {
        background: rgba(255, 255, 255, .95);
        border-radius: 10px;
        text-align: center;
        line-height: 1.2;
        box-shadow: 0 4px 10px rgba(0, 0, 0, .25);
    }

    /* ì¹´ë“œ ë‚´ë¶€ */
    .card-header {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .card-icon {
        font-size: 48px;
    }

    .card-temp {
        font-size: 38px;
        font-weight: bold;
    }

    .meta-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 20px;
    }

    .meta-item {
        background: #f4f6fa;
        border-radius: 10px;
        padding: 12px;
        text-align: center;
        font-size: 13px;
    }

    .pm-box {
        margin-top: 18px;
        padding: 14px;
        border-radius: 10px;
        background: #eef3ff;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='/districts.js') }}"></script>

<script>
    /* =====================
       ìºì‹œ ì„¤ì • (20ë¶„)
    ===================== */
    const CACHE_TTL = 20 * 60 * 1000;

    function getCache(key) {
        const raw = localStorage.getItem(key);
        if (!raw) return null;

        const {time, data} = JSON.parse(raw);
        if (Date.now() - time > CACHE_TTL) {
            localStorage.removeItem(key);
            return null;
        }
        return data;
    }

    function setCache(key, data) {
        localStorage.setItem(key, JSON.stringify({
            time: Date.now(),
            data
        }));
    }

    /* =====================
       ë‚ ì”¨ ìƒíƒœ ë§¤í•‘
    ===================== */
    const WEATHER_STATUS = {
        'ë¹„ ì—†ìŒ': {icon: 'â˜€ï¸', text: 'ë§‘ìŒ'},
        'ë¹„': {icon: 'ğŸŒ§', text: 'ë¹„'},
        'ì†Œë‚˜ê¸°': {icon: 'ğŸŒ¦', text: 'ì†Œë‚˜ê¸°'},
        'ëˆˆ': {icon: 'â„ï¸', text: 'ëˆˆ'},
        'ë¹„/ëˆˆ': {icon: 'ğŸŒ¨', text: 'ë¹„/ëˆˆ'}
    };

    /* =====================
       ì§€ë„ ì´ˆê¸°í™”
    ===================== */
    const map = L.map('map').setView([37.5665, 126.9780], 11);

    L.tileLayer(
            'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
            {
                attribution: '&copy; OpenStreetMap & CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }
    ).addTo(map);

    const markers = [];

    /* =====================
       ì¤Œë³„ ë¼ë²¨ ìŠ¤í™
    ===================== */
    function getLabelSpec(zoom) {
        if (zoom >= 12) return {font: 14, pad: '6px 10px', size: [95, 48]};
        if (zoom >= 11) return {font: 12, pad: '4px 8px', size: [80, 40]};
        if (zoom >= 10) return {font: 10, pad: '3px 6px', size: [65, 32]};
        return null;
    }

    /* =====================
       ì•„ì´ì½˜ ìƒì„±
    ===================== */
    function createIcon(d, temp, rainType, zoom) {
        const spec = getLabelSpec(zoom);
        if (!spec) return null;

        const status = WEATHER_STATUS[rainType] || WEATHER_STATUS['ë¹„ ì—†ìŒ'];

        return L.divIcon({
            className: '',
            html: `
        <div class="weather-label"
             style="font-size:${spec.font}px; padding:${spec.pad}">
            <div>${d.name}</div>
            <div><b>${status.icon} ${temp}Â°C</b></div>
        </div>
        `,
            iconSize: spec.size,
            iconAnchor: [spec.size[0] / 2, spec.size[1] / 2]
        });
    }

    /* =====================
       êµ¬ë³„ ë‚ ì”¨ ë¡œë“œ
    ===================== */
    async function loadDistrict(d) {
        const key = `weather_${d.name}`;
        let data = getCache(key);

        if (!data) {
            const res = await fetch(`/weather/current?lat=${d.lat}&lng=${d.lng}`);
            data = await res.json();
            if (data.error) return;
            setCache(key, data);
        }

        const w = data.weather;

        const marker = L.marker([d.lat, d.lng]).addTo(map);
        marker._weather = {
            district: d,
            temp: w.temperature,
            rainType: w.rain_type,
            data
        };

        marker.setIcon(createIcon(d, w.temperature, w.rain_type, map.getZoom()));
        marker.on('click', () => showDetail(d.name, data));

        markers.push(marker);
    }

    /* =====================
       ì¤Œ ë³€ê²½ ëŒ€ì‘
    ===================== */
    map.on('zoomend', () => {
        const zoom = map.getZoom();
        markers.forEach(m => {
            const icon = createIcon(
                    m._weather.district,
                    m._weather.temp,
                    m._weather.rainType,
                    zoom
            );

            if (icon) {
                m.setOpacity(1);
                m.setIcon(icon);
            } else {
                m.setOpacity(0);
            }
        });
    });

    /* =====================
       ìƒì„¸ ì¹´ë“œ
    ===================== */
    function showDetail(name, data) {
        const w = data.weather;
        const f = data.forecast;
        const status = WEATHER_STATUS[w.rain_type] || WEATHER_STATUS['ë¹„ ì—†ìŒ'];

        document.getElementById('weatherCard').innerHTML = `
    <div class="card-header">
        <div class="card-icon">${status.icon}</div>
        <div>
            <strong>${name}</strong>
            <div class="card-temp">${w.temperature}Â°C</div>
            <small>${status.text}</small>
        </div>
    </div>

    <div class="meta-grid">
        <div class="meta-item">ğŸ’§ ìŠµë„<br>${w.humidity}%</div>
        <div class="meta-item">ğŸ’¨ í’ì†<br>${w.wind_speed} m/s</div>
        <div class="meta-item">â˜” ê°•ìˆ˜ëŸ‰<br>${w.precipitation || 0} mm</div>
        <div class="meta-item">ğŸ§­ í’í–¥<br>${w.wind_direction}</div>
    </div>

    <div class="pm-box">
        <strong>ğŸ˜· ë¯¸ì„¸ë¨¼ì§€</strong><br>
        ${f.overall.replace('â—‹','')}<br>
        <small>${f.description.replace('â—‹','')}</small>
    </div>
    `;
    }

    /* =====================
       ì´ˆê¸° ì‹¤í–‰
    ===================== */
    SEOUL_DISTRICTS.forEach(loadDistrict);
</script>
{% endblock %}
