{% extends "base.html" %}

{% block title %}ì„œìš¸ ë‚ ì”¨ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<h1>ğŸŒ¤ ì„œìš¸ í˜„ì¬ ë‚ ì”¨</h1>

<div class="weather-layout">
    <div id="map"></div>

    <div id="weatherCard" class="weather-card">
        <div class="placeholder">ì§€ë„ì—ì„œ êµ¬ë¥¼ í´ë¦­í•˜ì„¸ìš”</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
    .weather-layout {
        display: flex;
        gap: 24px;
    }

    /* ì§€ë„ */
    #map {
        width: 58%;
        height: 520px;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* ì¹´ë“œ */
    .weather-card {
        width: 42%;
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        font-family: "Noto Sans KR", sans-serif;
    }

    .placeholder {
        text-align: center;
        margin-top: 180px;
        color: #777;
    }

    /* ì¹´ë“œ í—¤ë” */
    .card-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
    }

    .card-icon {
        font-size: 52px;
    }

    .card-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .card-temp {
        font-size: 36px;
        font-weight: bold;
    }

    .measured-at {
        font-size: 13px;
        color: #555;
    }

    /* ë©”íƒ€ ê·¸ë¦¬ë“œ */
    .meta-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .meta-item {
        background: #f4f6fa;
        border-radius: 12px;
        padding: 14px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
    }

    .meta-item:hover {
        background: #e2e8f0;
    }

    hr {
        border: none;
        border-top: 1px solid #e2e8f0;
        margin: 24px 0;
    }

    /* ê³µê¸°ì§ˆ */
    .air-quality h4 {
        margin-bottom: 12px;
        font-size: 18px;
        font-weight: 600;
    }

    .air-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    /* ì§€ë„ ë¼ë²¨ */
    .weather-label {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        text-align: center;
        line-height: 1.2;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, border 0.15s ease;
    }

    .weather-label:hover {
        transform: scale(1.05);
    }

    .weather-label.active {
        border: 2px solid #4f7cff;
        box-shadow: 0 10px 25px rgba(79, 124, 255, 0.45);
        transform: scale(1.08);
        z-index: 10;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='/districts.js') }}"></script>

<script>
    // ìºì‹œ ì„¤ì •
    const CACHE_TTL = 60 * 60 * 1000;

    function getCache(key) {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const {time, data} = JSON.parse(raw);
        if (Date.now() - time > CACHE_TTL) {
            localStorage.removeItem(key);
            return null;
        }
        return data;
    }

    function setCache(key, data) {
        localStorage.setItem(key, JSON.stringify({time: Date.now(), data}));
    }

    // ë‚ ì”¨ ìƒíƒœ
    const WEATHER_STATUS = {
        'ë¹„ ì—†ìŒ': {icon: 'â˜€ï¸', text: 'ë§‘ìŒ'},
        'ë¹„': {icon: 'ğŸŒ§', text: 'ë¹„'},
        'ì†Œë‚˜ê¸°': {icon: 'ğŸŒ¦', text: 'ì†Œë‚˜ê¸°'},
        'ëˆˆ': {icon: 'â„ï¸', text: 'ëˆˆ'},
        'ë¹„/ëˆˆ': {icon: 'ğŸŒ¨', text: 'ë¹„/ëˆˆ'}
    };

    // ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map').setView([37.5665, 126.9780], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap & CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    const markers = [];

    function getLabelSpec(zoom) {
        if (zoom >= 12) return {font: 14, pad: '6px 10px', size: [95, 48]};
        if (zoom >= 11) return {font: 12, pad: '4px 8px', size: [80, 40]};
        if (zoom >= 10) return {font: 10, pad: '3px 6px', size: [65, 32]};
        return null;
    }

    function createIcon(d, temp, rainType, zoom) {
        const spec = getLabelSpec(zoom);
        if (!spec) return null;
        const status = WEATHER_STATUS[rainType] || WEATHER_STATUS['ë¹„ ì—†ìŒ'];
        return L.divIcon({
            className: '',
            html: `<div class="weather-label"><div>${d.name}</div><div><b>${status.icon} ${temp}Â°C</b></div></div>`,
            iconSize: spec.size,
            iconAnchor: [spec.size[0] / 2, spec.size[1] / 2]
        });
    }

    // êµ¬ë³„ ë‚ ì”¨ ë¡œë“œ
    async function loadDistrict(d) {
        const key = `weather_${d.name}`;
        let data = getCache(key);
        if (!data) {
            const res = await fetch(`/api/weather?lat=${d.lat}&lng=${d.lng}&district=${d.name}`);
            data = await res.json();
            if (data.error) return;
            setCache(key, data);
        }

        const w = data.weather;
        const marker = L.marker([d.lat, d.lng]).addTo(map);
        marker._weather = {district: d, temp: w.temperature, rainType: w.rain_type, data};
        marker.setIcon(createIcon(d, w.temperature, w.rain_type, map.getZoom()));
        marker.on('click', () => {
            document.querySelectorAll('.weather-label.active').forEach(el => el.classList.remove('active'));
            const el = marker.getElement()?.querySelector('.weather-label');
            if (el) el.classList.add('active');
            showDetail(d.name, data);
        });
        markers.push(marker);
    }

    // ì¤Œ ë³€ê²½
    map.on('zoomend', () => {
        const zoom = map.getZoom();
        markers.forEach(m => {
            const icon = createIcon(m._weather.district, m._weather.temp, m._weather.rainType, zoom);
            if (icon) {
                m.setOpacity(1);
                m.setIcon(icon);
            } else {
                m.setOpacity(0);
            }
        });
    });

    // ë°œí‘œì‹œê°„ í¬ë§·
    function formatMeasuredAt(raw) {
        const year = raw.slice(0, 4);
        const month = parseInt(raw.slice(4, 6), 10);
        const day = parseInt(raw.slice(6, 8), 10);
        const hour = parseInt(raw.slice(8, 10), 10);
        const min = raw.slice(10, 12);
        return `${year}ë…„ ${month}ì›” ${day}ì¼ ${hour}ì‹œ${min !== '00'? min+'ë¶„':''}`;
    }

    // ìƒì„¸ ì¹´ë“œ
    function showDetail(name, data) {
        const w = data.weather;
        const a = data.air;
        const status = WEATHER_STATUS[w.rain_type] || WEATHER_STATUS['ë¹„ ì—†ìŒ'];

        document.getElementById('weatherCard').innerHTML = `
<div class="card-header">
    <div class="card-icon">${status.icon}</div>
    <div class="card-info">
        <strong>${name}</strong>
        <div class="card-temp">${w.temperature}Â°C</div>
        <small>${status.text}</small>
        <div class="measured-at">ğŸ•’ ë°œí‘œ ì‹œê°„: ${formatMeasuredAt(a.measured_at)}</div>
    </div>
</div>

<div class="meta-grid">
    <div class="meta-item">ğŸ’§ ìŠµë„<br>${w.humidity}%</div>
    <div class="meta-item">ğŸ’¨ í’ì†<br>${w.wind_speed} m/s</div>
    <div class="meta-item">â˜” ê°•ìˆ˜ëŸ‰<br>${w.precipitation || 0} mm</div>
    <div class="meta-item">ğŸ§­ í’í–¥<br>${w.wind_direction}</div>
</div>

<hr>

<div class="air-quality">
    <h4>ëŒ€ê¸°í™˜ê²½</h4>
    <div class="meta-grid air-grid">
        <div class="meta-item">ğŸ™ï¸ ëŒ€ê¸°ì§ˆ<br>${a.air_grade}</div>
        <div class="meta-item">ğŸŒ«ï¸ ë¯¸ì„¸ë¨¼ì§€<br>${a.pm10} Âµg/mÂ³</div>
        <div class="meta-item">ğŸŒ«ï¸ ì´ˆë¯¸ì„¸ë¨¼ì§€<br>${a.pm2_5} Âµg/mÂ³</div>
        <div class="meta-item">âš ï¸ ì£¼ìš” ì˜¤ì—¼ë¬¼ì§ˆ<br>${a.main_pollutant}</div>
    </div>
</div>`;
    }

    // ì´ˆê¸° ì‹¤í–‰
    SEOUL_DISTRICTS.forEach(loadDistrict);

</script>
{% endblock %}
