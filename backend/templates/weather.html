{% extends "base.html" %}

{% block title %}ì„œìš¸ ë‚ ì”¨ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<div class="weather-container">
    <div class="weather-header">
        <div class="header-content">
            <h1 class="main-title">
                <span class="icon">ğŸŒ¤ï¸</span>
                ì„œìš¸ ì‹¤ì‹œê°„ ë‚ ì”¨
            </h1>
            <p class="subtitle">ì§€ë„ì—ì„œ êµ¬ë¥¼ ì„ íƒí•˜ì—¬ ë‚ ì”¨ì™€ ëŒ€ê¸°ì§ˆ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
    </div>

    <div class="content-grid">
        <div class="map-section">
            <div id="map" class="map-container"></div>
        </div>

        <div class="info-section">
            <div id="weatherCard" class="info-card">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ—ºï¸</div>
                    <h3>êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                    <p>ì§€ë„ì—ì„œ ì›í•˜ëŠ” êµ¬ë¥¼ í´ë¦­í•˜ë©´<br>ì‹¤ì‹œê°„ ë‚ ì”¨ì™€ ëŒ€ê¸°ì§ˆ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <div class="weather-graph">
        <h2>ìµœê·¼ 24ì‹œê°„ êµ¬ë³„ ê¸°ì˜¨Â·ë¯¸ì„¸ë¨¼ì§€</h2>

        {% if image_path %}
        <img src="{{ image_path }}"
             alt="ì„œìš¸ êµ¬ë³„ ê¸°ì˜¨Â·ë¯¸ì„¸ë¨¼ì§€"
             style="width:100%; max-width:900px; border-radius:12px;
                    box-shadow:0 4px 20px rgba(0,0,0,0.2); cursor:zoom-in;"
             onclick="openGraphModal('{{ image_path }}')">
        {% else %}
        <p>ìµœê·¼ 24ì‹œê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>

    <div id="graphModal" class="graph-modal">
        <span class="graph-close">&times;</span>
        <img id="graphModalImg">
    </div>

</div>
{% endblock %}

{% block extra_css %}
<!-- Leaflet ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ CSS: ì§€ë„ íƒ€ì¼, ë§ˆì»¤, ì¤Œ ë²„íŠ¼ ë“± í™”ë©´ ìŠ¤íƒ€ì¼ ì ìš© -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

    .weather-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }

    .weather-header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
    }

    .main-title {
        font-size: 36px;
        font-weight: 800;
        color: #1a202c;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

    .main-title .icon {
        font-size: 42px;
        animation: rotate 10s linear infinite;
    }

    .weather-graph {
        margin: 32px 0;
        padding: 16px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .weather-graph h2 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 16px;
    }

    .graph-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
    }

    .graph-modal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    }

    .graph-close {
        position: absolute;
        top: 20px;
        right: 28px;
        font-size: 36px;
        color: white;
        cursor: pointer;
    }


    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .subtitle {
        font-size: 16px;
        color: #718096;
        margin-left: 54px;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1.3fr 1fr;
        gap: 24px;
        align-items: start;
    }

    .map-section {
        position: relative;
    }

    .map-container {
        width: 100%;
        height: 600px;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        border: 4px solid rgba(255, 255, 255, 0.9);
    }

    .info-section {
        position: sticky;
        top: 24px;
    }

    .info-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 32px;
        min-height: 600px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        overflow-y: auto;
        max-height: 600px;
    }

    .info-card::-webkit-scrollbar {
        width: 8px;
    }

    .info-card::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .info-card::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #718096;
    }

    .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.6;
    }

    .empty-state h3 {
        font-size: 24px;
        color: #2d3748;
        margin-bottom: 12px;
    }

    .empty-state p {
        font-size: 15px;
        line-height: 1.6;
    }

    /* Weather Card */
    .weather-detail {
        animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .weather-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 32px;
        color: white;
        text-align: center;
        margin-bottom: 24px;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    .weather-hero-icon {
        font-size: 80px;
        margin-bottom: 16px;
        animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-10px);
        }
    }

    .weather-location {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .weather-temp {
        font-size: 56px;
        font-weight: 900;
        line-height: 1;
        margin-bottom: 8px;
    }

    .weather-status {
        font-size: 18px;
        opacity: 0.9;
        margin-bottom: 12px;
    }

    .weather-time {
        font-size: 13px;
        opacity: 0.8;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    /* ===============================
       ì˜¤ì—¼ ì›ì¸ ì„¤ëª…
    =============================== */
    .pollutant-detail {
        margin-top: 20px;
        padding: 20px;
        border-radius: 14px;
        background: linear-gradient(135deg, #fffaf0, #fef3c7);
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
    }

    .pollutant-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #92400e;
    }

    .pollutant-desc {
        font-size: 14px;
        line-height: 1.6;
        color: #78350f;
    }


    .weather-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }

    .metric-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .metric-card:hover {
        background: white;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .metric-icon {
        font-size: 32px;
        margin-bottom: 8px;
    }

    .metric-label {
        font-size: 13px;
        color: #718096;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 20px;
        font-weight: 700;
        color: #1a202c;
    }

    .divider {
        height: 2px;
        background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
        margin: 24px 0;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .air-quality {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        padding: 24px;
    }

    .air-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .air-item {
        background: white;
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .air-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .air-icon {
        font-size: 28px;
        margin-bottom: 8px;
    }

    .air-label {
        font-size: 12px;
        color: #718096;
        margin-bottom: 4px;
    }

    .air-value {
        font-size: 18px;
        font-weight: 700;
        color: #1a202c;
    }

    /* Map Labels */
    .weather-label {
        display: inline-block;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 8px 12px;
        text-align: center;
        line-height: 1.3;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid rgba(102, 126, 234, 0.3);
        font-weight: 600;
    }

    .weather-label:hover {
        transform: scale(1.08);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        border-color: #667eea;
    }

    .weather-label.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        transform: scale(1.12);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        z-index: 1000;
    }

    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 16px;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }


    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        font-size: 18px;
        color: #667eea;
        font-weight: 600;
    }

    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }

        .info-section {
            position: static;
        }

        .map-container {
            height: 400px;
        }

        .info-card {
            min-height: 400px;
            max-height: none;
        }
    }

    @media (max-width: 768px) {
        .main-title {
            font-size: 28px;
        }

        .main-title .icon {
            font-size: 32px;
        }

        .subtitle {
            font-size: 14px;
            margin-left: 44px;
        }

        .weather-temp {
            font-size: 48px;
        }

        .weather-metrics {
            grid-template-columns: 1fr;
        }

        .air-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

{% endblock %}
{% block extra_js %}
<!-- Leaflet ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ JS: ì§€ë„ ìƒì„±, ë§ˆì»¤Â·ë ˆì´ì–´Â·ì´ë²¤íŠ¸ ë“± ì§€ë„ ë™ì‘ ë‹´ë‹¹ -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Flask static í´ë”ì˜ districts.js ë¡œë“œ-->
<script src="{{ url_for('static', filename='/districts.js') }}"></script>

<script>
    //ê¸°ë³¸ ì„¤ì •
    const CACHE_TTL = 60 * 60 * 1000;
    const markers = [];

    const WEATHER_STATUS = {
        "ë¹„ ì—†ìŒ": {icon: "â˜€ï¸", text: "ë§‘ìŒ"},
        ë¹„: {icon: "ğŸŒ§ï¸", text: "ë¹„"},
        ì†Œë‚˜ê¸°: {icon: "ğŸŒ¦ï¸", text: "ì†Œë‚˜ê¸°"},
        ëˆˆ: {icon: "â„ï¸", text: "ëˆˆ"},
        "ë¹„/ëˆˆ": {icon: "ğŸŒ¨ï¸", text: "ë¹„/ëˆˆ"},
    };

    //ì£¼ìš” ì˜¤ì—¼ë¬¼ì§ˆ ì„¤ëª… ë§¤í•‘
    const POLLUTANT_INFO = {
        NO2: {
            label: "êµí†µ ì˜í–¥",
            desc: "ì°¨ëŸ‰ ë°°ê¸°ê°€ìŠ¤ ì¦ê°€ë¡œ ì´ì‚°í™”ì§ˆì†Œ(NOâ‚‚) ë†ë„ê°€ ë†’ì•„ì¡Œì–´ìš”.",
        },
        "PM-10": {
            label: "ì™¸ë¶€ ë¨¼ì§€",
            desc: "í™©ì‚¬ë‚˜ ì™¸ë¶€ ìœ ì… ë¨¼ì§€ ì˜í–¥ìœ¼ë¡œ ë¯¸ì„¸ë¨¼ì§€ê°€ ë§ì•„ìš”.",
        },
        "PM-2.5": {
            label: "ì—°ì†Œ ì˜í–¥",
            desc: "ë‚œë°©Â·ì—°ì†Œ ê³¼ì •ì—ì„œ ë°œìƒí•œ ì´ˆë¯¸ì„¸ë¨¼ì§€ê°€ ì›ì¸ì´ì—ìš”.",
        },
        O3: {
            label: "ê°•í•œ í–‡ë¹›",
            desc: "ê°•í•œ í–‡ë¹›ê³¼ ì˜¤ì—¼ë¬¼ì§ˆ ë°˜ì‘ìœ¼ë¡œ ì˜¤ì¡´ì´ ìƒì„±ëì–´ìš”.",
        },
        SO2: {
            label: "ì‚°ì—… ì˜í–¥",
            desc: "ì—°ë£Œ ì—°ì†Œë¡œ ì´ì‚°í™”í™© ë†ë„ê°€ ë†’ì•„ì¡Œì–´ìš”.",
        },
        CO: {
            label: "ë¶ˆì™„ì „ ì—°ì†Œ",
            desc: "ì°¨ëŸ‰ì´ë‚˜ ë³´ì¼ëŸ¬ì˜ ë¶ˆì™„ì „ ì—°ì†Œ ì˜í–¥ì´ì—ìš”.",
        },
    };

    //ìºì‹œ
    function getCache(key) {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const {time, data} = JSON.parse(raw);
        if (Date.now() - time > CACHE_TTL) {
            localStorage.removeItem(key);
            return null;
        }
        return data;
    }

    function setCache(key, data) {
        localStorage.setItem(
                key,
                JSON.stringify({
                    time: Date.now(),
                    data,
                })
        );
    }

    // Leaflet ì§€ë„ ìƒì„±: 'map' divì— ì„œìš¸ ì¢Œí‘œë¡œ ì´ˆê¸°í™”, ì¤Œ ë ˆë²¨ 11
    const map = L.map("map").setView([37.5665, 126.978], 11);

    L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
            {
                // ì§€ë„ ë°ì´í„° ì¶œì²˜ í‘œì‹œ
                attribution: "&copy; OpenStreetMap & CARTO",
                // ì§€ë„ì—ì„œ í—ˆìš©í•˜ëŠ” ìµœëŒ€ í™•ëŒ€ ìˆ˜ì¤€
                maxZoom: 19,
            }
    ).addTo(map); // CARTO ì§€ë„ íƒ€ì¼ì„ ë¶ˆëŸ¬ì™€ mapì— ì¶”ê°€ (ì‹¤ì œ ì§€ë„ ë°°ê²½)

    // ì•„ì´ì½˜ (ì¤Œì— ë”°ë¼ í¬ê¸° ë³€í™˜)
    function getLabelSpec(zoom) {
        if (zoom >= 12) return {size: [110, 56]};
        if (zoom >= 11) return {size: [95, 48]};
        if (zoom >= 10) return {size: [80, 40]};
        return null;
    }

    //êµ¬ ì´ë¦„ë§Œ í‘œì‹œí•˜ëŠ” ì•„ì´ì½˜ (ì´ˆê¸°)
    function createNameOnlyIcon(name, zoom) {
        const spec = getLabelSpec(zoom);
        if (!spec) return null;

        return L.divIcon({
            className: "",
            html: `
                    <div class="weather-label">
                        <div><b>${name}</b></div>
                    </div>
                `,
            iconSize: spec.size,
            iconAnchor: [spec.size[0] / 2, spec.size[1] / 2],
        });
    }

    // ì•„ì´ì½˜ (í´ë¦­ í›„ ì˜¨ë„ ì¶”ê°€)
    function createWeatherIcon(name, temp, rainType, zoom) {
        const spec = getLabelSpec(zoom);
        if (!spec) return null;

        const status = WEATHER_STATUS[rainType] || WEATHER_STATUS["ë¹„ ì—†ìŒ"];

        return L.divIcon({
            className: "",
            html: `
                    <div class="weather-label">
                        <div>${name}</div>
                        <div><b>${status.icon} ${temp}Â°C</b></div>
                    </div>
                `,
            iconSize: spec.size,
            iconAnchor: [spec.size[0] / 2, spec.size[1] / 2],
        });
    }

    //API í˜¸ì¶œ (í´ë¦­ ì‹œ)
    async function fetchDistrictWeather(d) {
        const key = `weather_${d.name}`;
        let data = getCache(key);

        if (!data) {
            const res = await fetch(
                    `/api/weather?lat=${d.lat}&lng=${d.lng}&district=${d.name}`
            );
            data = await res.json();
            if (data.error) throw new Error(data.error);
            setCache(key, data);
        }
        return data;
    }

    // measured_at í¬ë§· ë³€í™˜ : 202601131200 -> 2026ë…„ 1ì›” 13ì¼ 12ì‹œ
    function formatMeasuredAt(raw) {
        const y = raw.slice(0, 4);
        const m = raw.slice(4, 6);
        const d = raw.slice(6, 8);
        const h = raw.slice(8, 10);
        const min = raw.slice(10, 12);
        return `${y}ë…„ ${m}ì›” ${d}ì¼ ${h}ì‹œ${min !== "00" ? min + "ë¶„" : ""}`;
    }

    //ê·¸ë˜í”„ ì‚¬ì§„ í™•ëŒ€ ë³´ê¸°
    function openGraphModal(src) {
        const modal = document.getElementById("graphModal");
        const img = document.getElementById("graphModalImg");
        img.src = src;
        modal.style.display = "flex";
    }

    document.addEventListener("click", (e) => {
        if (
                e.target.classList.contains("graph-close") ||
                e.target.id === "graphModal"
        ) {
            document.getElementById("graphModal").style.display = "none";
        }
    });

    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            const modal = document.getElementById("graphModal");
            if (modal && modal.style.display === "flex") {
                modal.style.display = "none";
            }
        }
    });

    // ë‚ ì”¨ ì •ë³´ì°½ ë³´ê¸°
    function showDetail(name, data) {
        const w = data.weather;
        const a = data.air;
        const status = WEATHER_STATUS[w.rain_type] || WEATHER_STATUS["ë¹„ ì—†ìŒ"];

        const pollutant = POLLUTANT_INFO[a.main_pollutant] || {
            label: "ë³µí•© ì˜í–¥",
            desc: "ì—¬ëŸ¬ ì˜¤ì—¼ì›ì´ ë³µí•©ì ìœ¼ë¡œ ì‘ìš©í•˜ê³  ìˆì–´ìš”.",
        };

        document.getElementById("weatherCard").innerHTML = `
               <div class="weather-detail">
      <div class="weather-hero">
        <div class="weather-hero-icon">${status.icon}</div>
        <div class="weather-location">${name}</div>
        <div class="weather-temp">${w.temperature}Â°C</div>
        <div class="weather-status">${status.text}</div>

        <div class="weather-time">ğŸ•’ ${formatMeasuredAt(a.measured_at)}</div>
      </div>

      <!-- ê¸°ìƒ ìƒì„¸ -->
      <div class="weather-metrics">
        <div class="metric-card">
          <div class="metric-icon">ğŸ’¨</div>
          <div class="metric-label">í’ì†</div>
          <div class="metric-value">${w.wind_speed} m/s</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">ğŸ§­</div>
          <div class="metric-label">í’í–¥</div>
          <div class="metric-value">${w.wind_direction}</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">ğŸ’§</div>
          <div class="metric-label">ìŠµë„</div>
          <div class="metric-value">${w.humidity}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">ğŸŒ§ï¸</div>
          <div class="metric-label">ê°•ìˆ˜ëŸ‰</div>
          <div class="metric-value">${w.precipitation || 0} mm</div>
        </div>
      </div>
      <div class="divider"></div>

      <!-- ëŒ€ê¸°ì§ˆ -->
      <div class="air-quality">
        <div class="section-title">ğŸŒ«ï¸ ëŒ€ê¸°í™˜ê²½</div>
        <div class="air-grid">
          <div class="air-item"><b>ëŒ€ê¸°ì§ˆ</b><br />${a.air_grade}</div>
          <div class="air-item"><b>PM10</b><br />${a.pm10}</div>
          <div class="air-item"><b>PM2.5</b><br />${a.pm2_5}</div>
          <div class="air-item">
            <b>ì£¼ìš” ì˜¤ì—¼ë¬¼ì§ˆ</b><br />${a.main_pollutant}
          </div>
        </div>

        <!-- ì˜¤ì—¼ ì›ì¸ ì„¤ëª… -->
        <div class="pollutant-detail">
          <div class="pollutant-title">ğŸ” ${pollutant.label}</div>
          <div class="pollutant-desc">${pollutant.desc}</div>
        </div>
      </div>

      <!-- ê·¸ë˜í”„ -->
      <div class="weather-graph" style="margin-top: 24px">
        <h2>ìµœê·¼ 48ì‹œê°„ ê¸°ì˜¨Â·ë¯¸ì„¸ë¨¼ì§€</h2>
        ${
                data.graph_path
                ? `
                <img
                src="${data.graph_path}"
                style="width: 100%; max-width: 800px; cursor: zoom-in"
                onclick="openGraphModal('${data.graph_path}')"
                />
                `
                : `
                <p>ê·¸ë˜í”„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                `
                }
      </div>
    </div>
            `;
    }

    //ë§ˆì»¤ ìƒì„± (êµ¬ ì´ë¦„ë§Œ)
    function createMarker(d) {
        const marker = L.marker([d.lat, d.lng], {
            icon: createNameOnlyIcon(d.name, map.getZoom()),
        }).addTo(map);

        marker.on("click", async () => {
            document
                    .querySelectorAll(".weather-label.active")
                    .forEach((el) => el.classList.remove("active"));

            document.getElementById("weatherCard").innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                `;

            try {
                const data = await fetchDistrictWeather(d);
                showDetail(d.name, data);

                marker.setIcon(
                        createWeatherIcon(
                                d.name,
                                data.weather.temperature,
                                data.weather.rain_type,
                                map.getZoom()
                        )
                );

                marker
                        .getElement()
                        ?.querySelector(".weather-label")
                        ?.classList.add("active");
            } catch (e) {
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
            }
        });

        markers.push(marker);
    }

    //ì¤Œ ë³€ê²½ ì‹œ ì•„ì´ì½˜ ìœ ì§€

    map.on("zoomend", () => {
        const zoom = map.getZoom();
        markers.forEach((m) => {
            const el = m.getElement();
            if (!el) return;

            const text = el.innerText;
            const name = text.split("\n")[0];
            const hasTemp = text.includes("Â°C");

            if (!hasTemp) {
                m.setIcon(createNameOnlyIcon(name, zoom));
            }
        });
    });

    //ì´ˆê¸° ë¡œë”© (ë§ˆì»¤ë§Œ ìƒì„±)
    SEOUL_DISTRICTS.forEach(createMarker);

</script>
{% endblock %}
