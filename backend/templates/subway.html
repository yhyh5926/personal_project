{% extends "base.html" %}

{% block title %}ì„œìš¸ ì§€í•˜ì²  ì •ë³´{% endblock %}

{% block content %}
<h1>ğŸš‡ ì„œìš¸ ì§€í•˜ì²  ì‹¤ì‹œê°„ ë„ì°© ì •ë³´</h1>

<div class="traffic-layout">
    <div id="map"></div>

    <div id="trafficCard" class="traffic-card">
        <p class="placeholder">ì§€ë„ì—ì„œ ì—­ì„ í´ë¦­í•˜ì„¸ìš”.</p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
    .traffic-layout {
        display: flex;
        gap: 24px;
    }

    #map {
        width: 55%;
        height: 520px;
        border-radius: 14px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, .15);
    }

    .traffic-card {
        width: 45%;
        border-radius: 14px;
        padding: 24px;
        background: #f6f8fb;
        box-shadow: 0 8px 20px rgba(0, 0, 0, .15);
        font-size: 14px;
    }

    .placeholder {
        text-align: center;
        color: #777;
        margin-top: 200px;
    }

    .station-label {
        padding: 6px 10px;
        border-radius: 10px;
        font-size: 13px;
        background: #fff;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .25);
        cursor: pointer;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='stations.js') }}"></script>

<script>
    /* =====================
       ì§€ë„ ì´ˆê¸°í™”
    ===================== */
    const map = L.map('map').setView([37.5665, 126.9780], 11);

    L.tileLayer(
            'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
            {
                attribution: '&copy; OpenStreetMap & CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }
    ).addTo(map);

    /* =====================
       ì—­ ë§ˆì»¤ ìƒì„±
    ===================== */
    const stationMarkers = [];

    SEOUL_STATIONS.forEach(station => {
        const marker = L.marker(
                [station.lat, station.lng],
                {icon: createStationIcon(station, map.getZoom())}
        ).addTo(map);

        marker.station = station;
        marker.on('click', () => fetchSubway(station.name));

        stationMarkers.push(marker);
    });

    /* =====================
       ì¤Œ ë³€ê²½ ì‹œ ë¼ë²¨ ê°±ì‹ 
    ===================== */
    map.on('zoomend', () => {
        const zoom = map.getZoom();
        stationMarkers.forEach(m => {
            m.setIcon(createStationIcon(m.station, zoom));
        });
    });

    /* =====================
       ë¼ë²¨ ì•„ì´ì½˜
    ===================== */
    function createStationIcon(station, zoom) {
        let label = 'ğŸš‡';
        if (zoom >= 12) label = station.name;

        return L.divIcon({
            html: `<div class="station-label">${label}</div>`,
            className: '',
            iconSize: [100, 36],
            iconAnchor: [50, 18]
        });
    }

    /* =====================
       ì§€í•˜ì²  API í˜¸ì¶œ
    ===================== */
    async function fetchSubway(station_name) {
        const card = document.getElementById('trafficCard');
        card.innerHTML = 'ğŸš‡ ì§€í•˜ì²  ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

        try {
            const res = await fetch(`/api/subway?station=${station_name}`);

            const data = await res.json();
            if (data.error) {
                card.innerHTML = data.error;
                return;
            }

            renderSubwayCard(data);
        } catch (e) {
            card.innerHTML = 'âŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
        }
    }

    /* =====================
       ì¹´ë“œ ë Œë”ë§
    ===================== */
    function renderSubwayCard(data) {
        const card = document.getElementById('trafficCard');
        console.log('ìš”ì²­ ì„±ê³µ',data)
        card.innerHTML = `
        <h3>ğŸš‰ ${data.current_station}</h3>

        <p>ğŸš‡ ë…¸ì„ : <b>${data.line}</b></p>
        <p>ğŸš† ì—´ì°¨ ì¢…ë¥˜: ${data.train_type || '-'}</p>
        <p>â†•ï¸ ë°©í–¥: ${data.direction}</p>
        <p>ğŸ¯ ì¢…ì°©ì—­: ${data.destination}</p>

        <hr>

        <h2 style="font-size:32px;margin:12px 0">
            â± ${data.arrival_in}
        </h2>

        <p>ğŸ“¢ ${data.arrival_message}</p>
    `;
    }
</script>
{% endblock %}
